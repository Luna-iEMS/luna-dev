name: ğŸ”„ Sync Project Plan to GitHub Board (v3)

on:
  push:
    paths:
      - 'docs/project-plan.yml'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'   # jeden Montag 06:00 Uhr

permissions:
  contents: read
  issues: read
  organization-projects: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------
      # 1ï¸âƒ£ Repository auschecken
      # -----------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 2ï¸âƒ£ GitHub CLI installieren (fÃ¼r Projects API)
      # -----------------------------------------------------
      - name: ğŸ§° Setup GitHub CLI
        uses: cli/cli-action@v2

      # -----------------------------------------------------
      # 3ï¸âƒ£ GitHub Project Board auslesen
      # -----------------------------------------------------
      - name: ğŸ” Locate Project Board via GraphQL API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Suche nach Projektboard 'ğŸŒ™ Luna-IEMS Development Board'..."
          gh api graphql -f query='
            query {
              organization(login: "Luna-IEMS") {
                projectsV2(first: 10) {
                  nodes { id title url }
                }
              }
            }' > projects.json

          cat projects.json | jq -r '.data.organization.projectsV2.nodes[] | "\(.title) â†’ \(.id) (\(.url))"'

          export PROJECT_ID=$(cat projects.json | jq -r '.data.organization.projectsV2.nodes[] | select(.title=="ğŸŒ™ Luna-IEMS Development Board") | .id')
          if [ -z "$PROJECT_ID" ]; then
            echo "âŒ Kein passendes Board gefunden. Bitte sicherstellen, dass das Project in der Orga 'Luna-IEMS' existiert."
            exit 1
          fi
          echo "âœ… Board gefunden mit ID: $PROJECT_ID"

      # -----------------------------------------------------
      # 4ï¸âƒ£ YAML-Datei prÃ¼fen und anzeigen
      # -----------------------------------------------------
      - name: ğŸ“š Inspect project-plan.yml
        run: |
          echo "ğŸ§¾ PrÃ¼fe docs/project-plan.yml..."
          head -20 docs/project-plan.yml || echo "âš ï¸ Datei nicht gefunden!"
          echo "âœ… YAML erfolgreich geladen."

      # -----------------------------------------------------
      # 5ï¸âƒ£ API-Aufruf (Sync-Dummy, zukÃ¼nftige Issue-Syncs mÃ¶glich)
      # -----------------------------------------------------
      - name: ğŸ”„ Sync summary to Project Board description
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT_ID=$(cat projects.json | jq -r '.data.organization.projectsV2.nodes[] | select(.title=="ğŸŒ™ Luna-IEMS Development Board") | .id')
          echo "ğŸª„ Aktualisiere Beschreibung des Boards..."
          gh api graphql -f query='
            mutation($project:ID!, $desc:String!) {
              updateProjectV2(input: { projectId: $project, shortDescription: $desc }) {
                projectV2 { title shortDescription }
              }
            }' -f project="$PROJECT_ID" -f desc="ğŸš€ Automatischer Sync: $(date -u)"
          echo "âœ… Sync abgeschlossen."
