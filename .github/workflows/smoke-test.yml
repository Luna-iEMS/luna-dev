name: ğŸ”¥ Luna IEMS Smoke Test v2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   

jobs:
  smoke-test:
    name: ğŸ§ª End-to-End Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      # -----------------------------------------------------
      # 1ï¸âƒ£ Repository auschecken
      # -----------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 2ï¸âƒ£ Docker-VerfÃ¼gbarkeit prÃ¼fen
      # -----------------------------------------------------
      - name: ğŸ‹ Check Docker availability
        run: |
          echo "ğŸ” PrÃ¼fe Docker..."
          docker version
          docker info

      # -----------------------------------------------------
      # 3ï¸âƒ£ Docker Compose Stack starten
      # -----------------------------------------------------
      - name: ğŸ³ Start Luna IEMS stack
        run: |
          echo "ğŸš€ Starte Luna IEMS Stack via docker-compose..."
          docker compose -f docker-compose.yml up -d
          docker compose ps

      # -----------------------------------------------------
      # 4ï¸âƒ£ Warten, bis alle Services bereit sind
      # -----------------------------------------------------
      - name: ğŸ•’ Wait for core services
        run: |
          echo "â³ Warte auf API, Qdrant, Tika und Ollama..."
          for i in {1..30}; do
            API=$(curl -fs http://localhost:8000/health || true)
            QDRANT=$(curl -fs http://localhost:6333/readyz || true)
            TIKA=$(curl -fs http://localhost:9998/tika || true)
            OLLAMA=$(curl -fs http://localhost:11434/api/tags || true)
            if [ -n "$API" ] && [ -n "$QDRANT" ] && [ -n "$TIKA" ] && [ -n "$OLLAMA" ]; then
              echo "âœ… Alle Services sind bereit!"
              break
            fi
            echo "âŒ› Versuch $i/30 â€“ warte 5 Sekunden..."
            sleep 5
          done

      # -----------------------------------------------------
      # 5ï¸âƒ£ /health Endpoint prÃ¼fen (API)
      # -----------------------------------------------------
      - name: ğŸŒ Check API /health endpoint
        run: |
          echo "ğŸŒ™ PrÃ¼fe FastAPI /health endpoint..."
          curl -v -f http://localhost:8000/health
          echo "âœ… API /health erfolgreich!"

      # -----------------------------------------------------
      # 6ï¸âƒ£ Upload-/Ingest-Test (End-to-End)
      # -----------------------------------------------------
      - name: ğŸ“¤ Test file upload ingest endpoint
        run: |
          echo "ğŸ“¤ Teste Datei-Upload Ã¼ber Ingest API..."
          curl -v -f -X POST http://localhost:8000/api/v1/ingest/upload \
            -F "file=@data/docs/test2.txt"
          echo "âœ… Upload erfolgreich!"

      # -----------------------------------------------------
      # 7ï¸âƒ£ Markdown-Testreport generieren
      # -----------------------------------------------------
      - name: ğŸ“ Generate test report
        run: |
          echo "ğŸ§¾ Erstelle Smoke Test Report..."
          mkdir -p artifacts
          REPORT="artifacts/smoke_report.md"
          echo "# ğŸ§ª Luna IEMS Smoke Test Report" > $REPORT
          echo "**Date:** $(date -u)" >> $REPORT
          echo "**Commit:** $GITHUB_SHA" >> $REPORT
          echo "" >> $REPORT
          echo "## âœ… Ergebnisse" >> $REPORT
          echo "- API /health erreichbar" >> $REPORT
          echo "- Upload/Ingest erfolgreich" >> $REPORT
          echo "" >> $REPORT
          echo "## ğŸ§© Service Status" >> $REPORT
          docker compose ps >> $REPORT
          echo "" >> $REPORT
          echo "## ğŸªµ Logs (API excerpt)" >> $REPORT
          docker compose logs api --tail=50 >> $REPORT
          echo "" >> $REPORT
          echo "## ğŸªµ Logs (Worker excerpt)" >> $REPORT
          docker compose logs worker --tail=50 >> $REPORT || true
          echo "" >> $REPORT
          echo "## ğŸš€ Finished successfully" >> $REPORT

      # -----------------------------------------------------
      # 8ï¸âƒ£ Artifact hochladen
      # -----------------------------------------------------
      - name: ğŸ“¦ Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: luna-smoke-report
          path: artifacts/smoke_report.md

      # -----------------------------------------------------
      # 9ï¸âƒ£ Report dauerhaft ins Repo schreiben
      # -----------------------------------------------------
      - name: ğŸ—‚ï¸ Commit CI report to /docs/ci_reports/
        if: success()
        run: |
          echo "ğŸ“š Speichere Report im Repository..."
          mkdir -p docs/ci_reports
          DATE=$(date +'%Y-%m-%d_%H-%M')
          cp artifacts/smoke_report.md docs/ci_reports/report_$DATE.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/ci_reports/
          git commit -m "ğŸ§¾ CI Smoke Report ($DATE)"
          git push

      # -----------------------------------------------------
      # ğŸ”Ÿ Logs bei Fehlern
      # -----------------------------------------------------
      - name: ğŸ” Print logs on failure
        if: failure()
        run: |
          echo "âŒ Smoke Test fehlgeschlagen â€“ Logs folgen:"
          docker compose logs --tail=100

      # -----------------------------------------------------
      # 11ï¸âƒ£ Cleanup
      # -----------------------------------------------------
      - name: ğŸ§¹ Stop and clean up
        if: always()
        run: |
          echo "ğŸ§¹ Entferne Container und Volumes..."
          docker compose down -v
