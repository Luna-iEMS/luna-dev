name: ğŸ”¥ Luna IEMS Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  smoke-test:
    name: ğŸ§ª End-to-End Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # -----------------------------------------------------
      # 1ï¸âƒ£ Repository auschecken
      # -----------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 2ï¸âƒ£ PrÃ¼fen, ob Docker verfÃ¼gbar ist
      # -----------------------------------------------------
      - name: ğŸ‹ Check Docker availability
        run: |
          echo "ğŸ” PrÃ¼fe Docker..."
          docker version
          docker info

      # -----------------------------------------------------
      # 3ï¸âƒ£ Docker Compose Umgebung starten
      # -----------------------------------------------------
      - name: ğŸ³ Start Luna IEMS stack (simplified mode)
        run: |
          echo "ğŸš€ Starte Luna IEMS Stack via docker-compose..."
          docker compose -f docker-compose.yml up -d
          echo "â³ Warte auf Services (API, Qdrant, Ollama, Tika, DB)..."
          sleep 75
          docker compose ps

      # -----------------------------------------------------
      # 4ï¸âƒ£ Healthcheck mit eigenem Script
      # -----------------------------------------------------
      - name: ğŸ©º Run healthcheck script
        run: |
          echo "ğŸ” Starte Healthcheck..."
          pip install requests
          python scripts/healthcheck.py || (echo 'âŒ Healthcheck fehlgeschlagen!' && exit 1)

      # -----------------------------------------------------
      # 5ï¸âƒ£ API /health Endpoint prÃ¼fen
      # -----------------------------------------------------
      - name: ğŸŒ Check API /health endpoint
        run: |
          echo "ğŸŒ™ PrÃ¼fe FastAPI /health endpoint..."
          curl -v -f http://localhost:8000/health

      # -----------------------------------------------------
      # 6ï¸âƒ£ Upload-/Ingest-Test
      # -----------------------------------------------------
      - name: ğŸ“¤ Test file upload ingest endpoint
        run: |
          echo "ğŸ“¤ Teste Datei-Upload Ã¼ber Ingest API..."
          curl -v -f -X POST http://localhost:8000/api/v1/ingest/upload \
            -F "file=@data/docs/test1.txt"
          echo "âœ… Upload erfolgreich!"

            # -----------------------------------------------------
      # ğŸ”„ Ingest Markdown-Report ins Repo & Historie
      # -----------------------------------------------------
      - name: ğŸ—‚ï¸ Commit Markdown Smoke Report to /docs/ci_reports/
        if: success()
        run: |
          echo "ğŸ“š Speichere Smoke Test Report im Repository..."
          mkdir -p docs/ci_reports
          DATE=$(date +'%Y-%m-%d_%H-%M')
          cp artifacts/smoke_results.md docs/ci_reports/report_$DATE.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/ci_reports/
          git commit -m "ğŸ§¾ Smoke Report ($DATE)"
          git push

      # -----------------------------------------------------
      # 7ï¸âƒ£ Statusreport als Markdown-Datei generieren
      # -----------------------------------------------------
      - name: ğŸ“ Generate test report
        run: |
          echo "ğŸ§¾ Erstelle Markdown-Report..."
          mkdir -p artifacts
          REPORT="artifacts/report.md"
          echo "# ğŸ§ª Luna IEMS Smoke Test Report" > $REPORT
          echo "Run: $GITHUB_RUN_NUMBER" >> $REPORT
          echo "Date: $(date -u)" >> $REPORT
          echo "Commit: $GITHUB_SHA" >> $REPORT
          echo "" >> $REPORT
          echo "## âœ… Zusammenfassung" >> $REPORT
          echo "- API Health: OK" >> $REPORT
          echo "- Upload Test: OK" >> $REPORT
          echo "" >> $REPORT
          echo "## ğŸ§© Service Status" >> $REPORT
          docker compose ps >> $REPORT
          echo "" >> $REPORT
          echo "## ğŸªµ Logs (API excerpt)" >> $REPORT
          docker compose logs api --tail=50 >> $REPORT

      # -----------------------------------------------------
      # 8ï¸âƒ£ Report als GitHub Artifact speichern
      # -----------------------------------------------------
      - name: ğŸ“¦ Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: luna-smoke-report
          path: artifacts/report.md

      # -----------------------------------------------------
      # 9ï¸âƒ£ Report dauerhaft ins Repo schreiben
      # -----------------------------------------------------
      - name: ğŸ—‚ï¸ Commit CI report to /docs/ci_reports/
        if: success()
        run: |
          echo "ğŸ“š Speichere Report im Repository..."
          mkdir -p docs/ci_reports
          DATE=$(date +'%Y-%m-%d_%H-%M')
          cp artifacts/report.md docs/ci_reports/report_$DATE.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/ci_reports/
          git commit -m "ğŸ§¾ CI report ($DATE)"
          git push

      # -----------------------------------------------------
      # ğŸ”Ÿ Logs bei Fehlern anzeigen
      # -----------------------------------------------------
      - name: ğŸ” Print logs on failure
        if: failure()
        run: |
          echo "âŒ Smoke Test fehlgeschlagen â€“ Logs folgen:"
          docker compose logs --tail=100

      # -----------------------------------------------------
      # 11ï¸âƒ£ Cleanup
      # -----------------------------------------------------
      - name: ğŸ§¹ Stop and clean up
        if: always()
        run: |
          echo "ğŸ§¹ Entferne Container und Volumes..."
          docker compose down -v

