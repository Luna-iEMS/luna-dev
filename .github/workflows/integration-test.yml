name: ğŸ§© Luna IEMS Integration Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  integration-test:
    name: ğŸ”¬ Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        ports: [ "5432:5432" ]
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: luna_test
        options: >-
          --health-cmd="pg_isready -U postgres -d luna_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
      qdrant:
        image: qdrant/qdrant:v1.11.0
        ports: [ "6333:6333" ]
        options: >-
          --health-cmd="curl -fs http://localhost:6333/readyz || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      # -----------------------------------------------------
      # 1ï¸âƒ£ Checkout
      # -----------------------------------------------------
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # 2ï¸âƒ£ Setup Python environment
      # -----------------------------------------------------
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -----------------------------------------------------
      # 3ï¸âƒ£ Install dependencies
      # -----------------------------------------------------
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------------------------------
      # 4ï¸âƒ£ Wait for DB + Qdrant
      # -----------------------------------------------------
      - name: ğŸ•’ Wait for core services
        run: |
          echo "â³ Warte auf Datenbank und Qdrant..."
          for i in {1..20}; do
            pg_isready -h localhost -U postgres && \
            curl -fs http://localhost:6333/readyz && break
            echo "âŒ› Versuch $i/20 â€“ warte 5 Sekunden..."
            sleep 5
          done

      # -----------------------------------------------------
      # 5ï¸âƒ£ Run API in background
      # -----------------------------------------------------
      - name: ğŸŒ™ Start API server (background)
        run: |
          uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          sleep 15
          curl -fs http://localhost:8000/health

      # -----------------------------------------------------
      # 6ï¸âƒ£ Run Integration Tests
      # -----------------------------------------------------
      - name: ğŸ§ª Run pytest integration suite
        run: |
          pytest -v -s --maxfail=1 --disable-warnings tests/integration

      # -----------------------------------------------------
      # 7ï¸âƒ£ Upload pytest results
      # -----------------------------------------------------
      - name: ğŸ“¦ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: luna-integration-results
          path: .pytest_cache/
