# Luna‑IEMS – Dashboard Architektur, UX & Playbook‑Integration (Technical Blueprint, Tech‑First)

> Ziel: Technisch belastbares Lastenheft für das Kundendashboard (UI/UX), klar an die bestehenden Services (API, RAG, Qdrant, Timescale/Postgres, MinIO, Ollama) angebunden. Fokus: Datenflüsse, Endpunkte, Schemas, Telemetrie, Rechte, Observability und Port‑Strategie. UI ist aus Entwicklersicht beschrieben (Komponenten + Payloads), visuelles Feintuning folgt später.

---

## 0. Leitplanken
- **Mandanten‑Isolierung**: 1 Stack pro Kunde (eigene DB‑Schemas + Qdrant‑Collections, optionale Shadow‑Pipelines für anonymisierte Global‑Modelle).
- **Port‑Strategie**: Dev nutzt **random/ephemereal** (compose `127.0.0.1:0` → *service discovery intern*). Prod nutzt festen **Traefik/NGINX‑Ingress** mit internem Port‑Mapping; Services sprechen **DNS‑Namen** (`postgres`, `qdrant`, `ollama`, `minio`, `api`). Keine festen Host‑Ports außer Ingress.
- **Contracts**: Alle Backend‑Antworten versioniert (`x-api-version: 1`), **strict JSON schema** (OpenAPI, `application/problem+json` für Fehler).
- **Observability**: Health, Metrics, Structured Logs, Traces. Client‑Events fließen in `/events` (DB: `events` Hypertable).

---

## 1. Systemübersicht (Runtime)

```
Browser ──(HTTPS)──▶  API‑Gateway/Ingress ──▶ FastAPI (api)
                                  │          ├─▶ Postgres/Timescale (metrics, items, chunks, events)
                                  │          ├─▶ Qdrant (Vektoren pro Mandant: collection `chunks_<tenant>`)
                                  │          ├─▶ MinIO (Rohdateien, Previews)
                                  │          └─▶ Ollama (Embeddings/Generate)
```

- **Tenant‑Key** via Header `X-Tenant-ID` (+ optional `X-User-ID`), serverseitig auf Auth‑Kontext gemappt.
- **Feature‑Flags** (`/features`) steuern UI‑Sektionen (Sim‑Feeds, RAG, Recommendations, Playbook‑Module).

---

## 2. Seitenplan (Customer Dashboard)

> Jeder Abschnitt enthält: **Zweck**, **UI‑Komponenten**, **API‑Kontrakte**, **Datenquellen**, **Telemetry**.

### 2.1 Home / Overview
- **Zweck**: Einstiegs‑KPI & Zustand, kontextuelle Playbook‑Hinweise (was jetzt wichtig ist).
- **UI**: KPI‑Cards (heute/7d/30d), Status Badges (System OK, Daten‑Feeds OK), Zeitreihen‑Mini‑Charts, „Luna Insight Panel“ (LLM‑zusammengefasste Highlights), Quick‑Actions (Upload, Frage stellen).
- **API**:
  - `GET /overview` → `{ kpis: {uptime, ingest_count, rag_usage, meter_points, market_records}, statuses: {...}, insights: [..] }`
  - `GET /playbook/insights?context=overview` → listet relevante Playbook‑Snippets.
- **Daten**: Postgres agg views, Timescale CAGGs, Events, Playbook DB.
- **Telemetry**: `view:overview`, KPI clicks, insight opens.

### 2.2 Luna Insight Panel (global sichtbar)
- **Zweck**: Kontextuelle Erklärungen/To‑dos, generiert aus Playbook + aktuellen Daten.
- **UI**: Dismissible Side‑Panel, Dark/Light, Markdown‑Renderer, Badge „Auto‑generated by Luna“.
- **API**: `POST /insights/contextual` → `{ context, user_goal? }` ⇒ `{ blocks: [{title, md, actions[]}] }`
- **Daten**: Playbook Store, Events/Traces; optional RAG über `chunks_<tenant>`.
- **Telemetry**: `insight_shown`, `insight_action_clicked`.

### 2.3 Data Hub (Uploads & Katalog)
- **Zweck**: Dokumente/Daten hochladen, Status der Verarbeitung, Suche/Browse.
- **UI**: Upload‑Dropzone, Table mit Status (queued→parsed→chunked→embedded), Facets (tags, source, kind), Preview Drawer.
- **API**:
  - `POST /ingest/doc` (multipart) ⇒ `{ item_id, chunks }`
  - `GET /ingest/items?query=...&tag=...&page=...` ⇒ Paginierte Liste
  - `GET /ingest/item/{id}` ⇒ Metadaten + Previews
  - Webhook‑Events: `ingest.status.changed`
- **Daten**: MinIO (raw), Postgres (`items`, `item_chunks`), Qdrant (`chunks_<tenant>`).
- **Telemetry**: `ingest_upload`, `ingest_status_view`.

### 2.4 RAG – Ask Luna
- **Zweck**: Fragen zur Wissensbasis beantworten, mit Quellen.
- **UI**: Prompt‑Box, Result Cards mit Zitaten [chunkId], Confidence Badge, „Ask‑again“ mit Guidance, Filter (tags, time).
- **API**: `POST /rag/ask` ⇒ `{ answer, chunks_used[], citations[], prompt_tokens, latency_ms }`
- **Daten**: Qdrant Search + DB fetch; Ollama generate.
- **Telemetry**: `rag_ask`, `rag_feedback` (helpful/not), `rag_latency`.

### 2.5 Smart Meter (Sim first)
- **Zweck**: Zeitreihen für Verbrauch/Produktion/Spannung, Alarme.
- **UI**: Multi‑Serie Chart, Range‑Picker, Anomalie‑Badges, Export, Vergleich Vorwoche.
- **API**:
  - `GET /meter/series?meter_id&from&to&agg=15m` ⇒ `[ {ts, consumption_kw, production_kw, voltage} ]`
  - `GET /meter/anomalies?meter_id&from&to` ⇒ `[ {ts, score, label} ]`
- **Daten**: Timescale Hypertable `smart_meter_readings` + CAGGs.
- **Telemetry**: `meter_view`, `meter_export`.

### 2.6 Marktpreise (Sim first)
- **Zweck**: Preisverlauf, Forecast‑Stub, Alerts.
- **UI**: Chart, Product‑Switch, Alert‑Rules (UI), „Was bedeutet das?“ Insight.
- **API**:
  - `GET /market/series?market&product&from&to&agg=15m`
  - `POST /market/alerts` ⇒ Regel anlegen (DB: `alerts`)
- **Daten**: Timescale `market_prices`.
- **Telemetry**: `market_view`, `alert_created`.

### 2.7 Empfehlungen (MVP)
- **Zweck**: Content‑Empfehlungen (dokumentenbasiert), später Bandit.
- **UI**: Cards mit Relevanz, „Warum?“-Erklärung (SHAP‑Stub), Feedback‑Buttons.
- **API**: `POST /recommend` ⇒ `{ items: [{chunk_id, score, payload}] }`
- **Daten**: Qdrant + Events.
- **Telemetry**: `rec_view`, `rec_feedback`.

### 2.8 Playbook (Guides & Automationen)
- **Zweck**: Kundenfähiger Leitfaden (aus EPRIS Playbook), versioniert, kontextualisiert.
- **UI**: Kapitel‑Baum, Suchleiste, „Anwenden auf meine Daten“ Button, Download PDF.
- **API**:
  - `GET /playbook/chapters`
  - `GET /playbook/chapter/{id}` ⇒ `{ md, last_updated, related_insights[] }`
  - `POST /playbook/apply` ⇒ erstellt Task/Automation (z. B. Report)
- **Daten**: Playbook Store (Postgres `playbook_*` Tabellen), optional Embeddings zur Querverlinkung.
- **Telemetry**: `playbook_view`, `playbook_apply`.

### 2.9 Hilfe & Support
- **Zweck**: Auto‑Generierte Hilfe (LLM), Tickets, Systemstatus.
- **UI**: FAQ‑Autosuggest (lokal), Ticket‑Form, Status Banner, Logs‑Selfcheck (high‑level).
- **API**: `POST /help/answer`, `POST /support/ticket`, `GET /status/summary`
- **Daten**: Help Knowledgebase (lokal), Events, Health Endpoints.
- **Telemetry**: `help_query`, `ticket_opened`.

### 2.10 Footer / Legal / System‑Badges
- **Zweck**: Mandant, Build‑Hash, Data Residency, Links.
- **API**: `GET /about` ⇒ `{ tenant, build, region, docs_url }`

---

## 3. Admin‑Dashboard (separat, nur Owner)
- **Sektionen**: System Health, Tenants, Ingest‑Pipelines, Modellverwaltung (Ollama Models), Feature Flags, Playbook CMS, Nutzer & Rollen, Audit Log.
- **wichtige Endpunkte**:
  - `GET /admin/health` (aggregiert über `/health/live|ready|deps`)
  - `POST /admin/ingest/reindex` (Qdrant neu aufbauen)
  - `POST /admin/models/pull` (Ollama Modell ziehen)
  - `POST /admin/playbook/publish` (Version bump)
  - `GET /admin/events?type=&from=&to=` (Audit/Telemetry)

---

## 4. Datenmodelle (relevant fürs UI)

### 4.1 Items & Chunks
```sql
TABLE items (
  item_id uuid PK,
  kind text, source text, title text, tags text[], url text,
  sha256 text, version int, created_at timestamptz
)
TABLE item_chunks (
  chunk_id uuid PK,
  item_id uuid FK, chunk_idx int, text text, metadata jsonb, created_at timestamptz
)
```
**Qdrant**: Collection pro Tenant `chunks_<tenant>` (Vector 768, COSINE), Payload: `{ item_id, chunk_idx, tags?, source? }`.

### 4.2 Events (Telemetry)
```sql
TABLE events (
  event_id uuid PK,
  user_id uuid NULL,
  ts timestamptz NOT NULL,
  type text NOT NULL,
  item_id uuid NULL,
  meta jsonb DEFAULT '{}'::jsonb
)
-- Hypertable: ts
```

### 4.3 Playbook
```sql
TABLE playbook_chapters (
  id uuid PK, slug text UNIQUE, title text, md text, version int, last_updated timestamptz
)
TABLE playbook_links (
  chapter_id uuid FK, item_id uuid NULL, tag text NULL
)
```

---

## 5. API‑Kontrakte (Auszug)

### 5.1 `/overview` (GET)
**Response**
```json
{
  "kpis": {"uptime": 99.98, "ingest_count": 1245, "rag_usage": 311, "meter_points": 43210, "market_records": 9821},
  "statuses": {"db": "ok", "qdrant": "ok", "ollama": "ok", "ingest": "degraded"},
  "insights": [{"title": "Preispeak erwartet", "md": "…", "severity": "info"}]
}
```

### 5.2 `/ingest/doc` (POST multipart)
**Form**: `file`, `kind`, `source`, optional `tags[]`
**Response**: `{ "item_id": "…", "chunks": 27 }`

### 5.3 `/rag/ask` (POST)
**Body**
```json
{ "question": "Was ist Antifragilität?", "top_k": 6, "filters": {"tag": "regulation"} }
```
**Response**
```json
{ "answer": "…", "chunks_used": ["…"], "citations": [{"chunk_id": "…", "score": 0.73}], "latency_ms": 812 }
```

### 5.4 `/meter/series` (GET)
**Query**: `meter_id, from, to, agg`
**Response**: Array `{ ts, consumption_kw, production_kw, voltage }`

### 5.5 `/market/series` (GET)
Analog zu Meter; `market, product`.

### 5.6 `/recommend` (POST)
**Body**: `{ "user_id": null, "top_k": 10 }`
**Response**: `{ "items": [{"chunk_id":"…","score":0.62,"payload":{"item_id":"…"}}] }`

### 5.7 `/help/answer` (POST)
**Body**: `{ "question": "…" }` ⇒ lokales LLM + Playbook; Rate‑Limit per Tenant/User.

---

## 6. UI‑Komponenten (Tech‑Sicht)
- **Shell**: Sidebar Nav (sektionsbasiert), Topbar (Tenant, User, Theme‑Switch), Footer (build hash).
- **Cards**: KPI, Status, Insight, Recommendation.
- **Charts**: Timeseries (Meter/Market), Area/Line, Aggregation serverseitig.
- **Tables**: Virtualized (10k+ Rows), Column‑Facets.
- **Panels**: Insight Drawer (global), Upload Drawer, Item Preview.
- **State Mgmt**: Query‑Cache (Stale‑While‑Revalidate), Error Boundaries, Skeletons.

---

## 7. Security & Rechte
- AuthN: Tenant‑lokal (OIDC später), vorerst API‑Key je Tenant.
- AuthZ: Rollen `viewer`, `editor`, `owner`. Upload nur `editor/owner`.
- Ratelimits (`/rag/ask`, `/help/answer`, `/ingest/doc`).
- Audit Log (DB `events`, type `auth.login`, `admin.action`).

---

## 8. Observability
- **Health**: `/health/live`, `/health/ready`, `/health/deps` (DB/Qdrant/Ollama/MinIO)
- **Metrics**: Prometheus (API Latenzen, RAG Treffer, Queue‑Tiefe), Grafana Dash.
- **Logs**: JSON‑Logs, Korrelation über `x-trace-id`.
- **Traces**: OpenTelemetry (HTTP Span, DB, Qdrant, Ollama‑Calls).

---

## 9. Simulation Layer (bis reale Feeds da sind)
- Dienste erzeugen Test‑Daten: `meter_sim`, `market_sim` (Topics/Direct‑Insert), idempotent, steuerbar via `/admin/sim/*`.
- Toggle pro Tenant (`features.simulation=true`).

---

## 10. Build/Deploy Hinweise
- **Dev**: `docker-compose.dev.yml` ohne feste Host‑Ports (nur API:8000). `.env` nur für dev.
- **Prod**: Ingress Controller, TLS, feste DNS, horizontale Skalierung API/Worker. Qdrant/DB mit Persistent Volumes.
- **Migrations**: Alembic/SQL‑Files, Startup Hook.

---

## 11. Offene Punkte (gezielt)
- Re‑Ranking Layer (BM25 + Cross‑Encoder) – optional ab v1.1
- Admin CMS für Playbook: Versionierung, Diff, Staging
- Multi‑Tenant‑Key‑Management (KMS) für Secrets
- Alerting UI (markt/meter) inkl. Policy‑Engine

---

## 12. Anhang – Typische Fehlerfälle & UX‑Handling
- **Ollama offline** → `/rag/ask` liefert 503 + Guidance; UI zeigt Retry + Info „Modelle nicht geladen“.
- **Qdrant leer** → RAG zeigt Seed‑Anleitung („Bitte laden Sie Dokumente hoch“).
- **Timescale Lag** → Charts zeigen Degradation‑Badge; Tooltips erklären Aggregation.
- **Upload groß** → Pre‑Flight Check (MIME, Größe), Chunking progress, Resume.

